using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using System.Data;
using X.PagedList;
using Young_Artists.Models;
using Young_Artists.ViewModels;

namespace Young_Artists.Controllers
{
    public class TicketOrderController : SuperController
    {
        public IActionResult List(int? id, string sortTicketOrder, int page = 1)
        {
			ViewBag.Account = HttpContext.Session.GetString(CDictionary.SK_LOINGED_ADMINID);
			//IEnumerable<TicketOrder> datas = null;
            YoungArtistsContext db = new YoungArtistsContext();
            if (id != null)
            {

                //datas = from t in db.TicketOrders
                //        where t.CustomerId == id
                //        select t;
				int pageSize = 10;
				ViewBag.SortBy = sortTicketOrder;
				var currentPage = page < 1 ? 1 : page;
				IPagedList<TicketOrder> results = null;
				switch (sortTicketOrder)
				{
					case "UpOrderId":
						results = db.TicketOrders.OrderBy(t => t.OrderId).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "DownOrderId":
						results = db.TicketOrders.OrderByDescending(t => t.OrderId).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "UpOrderCreateTimestamp":
						results = db.TicketOrders.OrderBy(t => t.OrderCreateTimestamp).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "DownOrderCreateTimestamp":
						results = db.TicketOrders.OrderByDescending(t => t.OrderCreateTimestamp).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "UpOrderUpdateTimestamp":
						results = db.TicketOrders.OrderBy(t => t.OrderUpdateTimestamp).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "DownOrderUpdateTimestamp":
						results = db.TicketOrders.OrderByDescending(t => t.OrderUpdateTimestamp).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "UpOrderUpdateId":
						results = db.TicketOrders.OrderBy(t => t.OrderUpdateId).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "DownOrderUpdateId":
						results = db.TicketOrders.OrderByDescending(t => t.OrderUpdateId).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "UpOrderState":
						results = db.TicketOrders.OrderBy(t => t.OrderState).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "DownOrderState":
						results = db.TicketOrders.OrderByDescending(t => t.OrderState).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "UpCustomerId":
						results = db.TicketOrders.OrderBy(t => t.CustomerId).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "DownCustomerId":
						results = db.TicketOrders.OrderByDescending(t => t.CustomerId).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "UpOrderTotalPrice":
						results = db.TicketOrders.OrderByDescending(t => t.OrderTotalPrice).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "DownOrderTotalPrice":
						results = db.TicketOrders.OrderByDescending(t => t.OrderTotalPrice).ToList().ToPagedList(currentPage, pageSize);
						break;
					default:
						results = db.TicketOrders.ToList().ToPagedList(currentPage, pageSize);
						break;

				}


				return View(results);
            }
            else
            {

                //datas = from t in db.TicketOrders
                //        select t;
                int pageSize = 10;
				ViewBag.SortBy = sortTicketOrder;
				var currentPage = page < 1 ? 1 : page;
				IPagedList<TicketOrder> results = null;
				switch (sortTicketOrder)
				{
					case "UpOrderId":
						results = db.TicketOrders.OrderBy(t => t.OrderId).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "DownOrderId":
						results = db.TicketOrders.OrderByDescending(t => t.OrderId).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "UpOrderCreateTimestamp":
						results = db.TicketOrders.OrderBy(t => t.OrderCreateTimestamp).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "DownOrderCreateTimestamp":
						results = db.TicketOrders.OrderByDescending(t => t.OrderCreateTimestamp).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "UpOrderUpdateTimestamp":
						results = db.TicketOrders.OrderBy(t => t.OrderUpdateTimestamp).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "DownOrderUpdateTimestamp":
						results = db.TicketOrders.OrderByDescending(t => t.OrderUpdateTimestamp).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "UpOrderUpdateId":
						results = db.TicketOrders.OrderBy(t => t.OrderUpdateId).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "DownOrderUpdateId":
						results = db.TicketOrders.OrderByDescending(t => t.OrderUpdateId).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "UpOrderState":
						results = db.TicketOrders.OrderBy(t => t.OrderState).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "DownOrderState":
						results = db.TicketOrders.OrderByDescending(t => t.OrderState).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "UpCustomerId":
						results = db.TicketOrders.OrderBy(t => t.CustomerId).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "DownCustomerId":
						results = db.TicketOrders.OrderByDescending(t => t.CustomerId).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "UpOrderTotalPrice":
						results = db.TicketOrders.OrderByDescending(t => t.OrderTotalPrice).ToList().ToPagedList(currentPage, pageSize);
						break;
					case "DownOrderTotalPrice":
						results = db.TicketOrders.OrderByDescending(t => t.OrderTotalPrice).ToList().ToPagedList(currentPage, pageSize);
						break;
					default:
						results = db.TicketOrders.ToList().ToPagedList(currentPage, pageSize);
						break;

				}

				return View(results);

            }
        }
        public IActionResult List_Detail(int? id)
        {
            IEnumerable<TicketOrderKeywordViewModel> datas = null;

            YoungArtistsContext db = new YoungArtistsContext();
            if (id != null)
            {
                datas = from to in db.TicketOrders
                        join tod in db.TicketOrderDetails on to.OrderId equals tod.OrderId
                        where tod.OrderId == id
                        select new TicketOrderKeywordViewModel { Id = tod.Id, OrderId = to.OrderId, OrderTotalPrice = to.OrderTotalPrice, OrderCreateTimestamp = to.OrderCreateTimestamp, OrderUpdateTimestamp = to.OrderUpdateTimestamp, OrderUpdateId = to.OrderUpdateId, EventId = tod.EventId, Area = tod.Area, SeatId = tod.SeatId, CustomerId = tod.CustomerId, OrderState = to.OrderState };


                return View(datas);
            }
            else
            {
                var datas_detail = from to in db.TicketOrders
								   join tod in db.TicketOrderDetails on to.OrderId equals tod.OrderId
								   select new TicketOrderKeywordViewModel {Id =tod.Id, OrderId = to.OrderId, OrderTotalPrice = to.OrderTotalPrice, OrderCreateTimestamp = to.OrderCreateTimestamp, OrderUpdateTimestamp = to.OrderUpdateTimestamp, OrderUpdateId = to.OrderUpdateId, EventId = tod.EventId, Area = tod.Area, SeatId = tod.SeatId, CustomerId = tod.CustomerId, OrderState = to.OrderState };
				return View(datas_detail);

            }
        }


        public IActionResult Create()
        {

            return View();
        }
        [HttpPost]
        public IActionResult Create( TicketOrder to)
        {
            YoungArtistsContext db = new YoungArtistsContext();
			ViewBag.Account = HttpContext.Session.GetString(CDictionary.SK_LOINGED_ADMINID);

			if (db.TicketOrders.Max(x => x.OrderId) == null)
            {
                to.OrderId = 1;
            }
            else
            {
                to.OrderId = db.TicketOrders.Max(x => x.OrderId) + 1;

            }
            to.CustomerId = 1;
            to.OrderCreateTimestamp = DateTime.Now.ToString("G");
            to.OrderUpdateTimestamp = DateTime.Now.ToString("G");
            to.OrderUpdateId = ViewBag.Account;
            
            db.TicketOrders.Add(to);
            db.SaveChanges();

            return RedirectToAction("List");
        }
        public IActionResult Delete(int? id)
        {
            YoungArtistsContext db = new YoungArtistsContext();

            if (id != null)
            {
                var datas = db.TicketOrders.FirstOrDefault(t => t.Id == id);

                var datasOrderId = datas.OrderId;
                var datasDetailCount = db.TicketOrderDetails.Count(t=>t.OrderId == datasOrderId);

                for (int i = 0; i < datasDetailCount;i++)
                {
                    Delete_Detail_All(datasOrderId);
                }

                db.Remove(datas);
                db.SaveChanges();
            }

            return RedirectToAction("List");
        }

        public IActionResult Edit(int? id)
        {
            if (id != null)
            {
                YoungArtistsContext db = new YoungArtistsContext();
                var datas = db.TicketOrders.FirstOrDefault(t => t.OrderId == id);
                if (datas != null)
                {

                    return View(datas);
                }
            }
            return RedirectToAction("List");
        }
        [HttpPost]
        public IActionResult Edit(TicketOrder t)
        {
			ViewBag.Account = HttpContext.Session.GetString(CDictionary.SK_LOINGED_ADMINID);

			YoungArtistsContext db = new YoungArtistsContext();
            var datas = db.TicketOrders.FirstOrDefault(d => d.OrderId == t.Id);
            if (datas != null)
            {
                datas.OrderUpdateId = Convert.ToInt32(ViewBag.Account);
				datas.OrderUpdateTimestamp = DateTime.Now.ToString("G");
                datas.OrderState = t.OrderState;
                datas.OrderTotalPrice = t.OrderTotalPrice;
                db.SaveChanges();
                return RedirectToAction("List");
            }

            return RedirectToAction("List");
        }


		public IActionResult Edit_Detail(int? id)
		{
			if (id != null)
			{
				YoungArtistsContext db = new YoungArtistsContext();
				var datas = db.TicketOrderDetails.FirstOrDefault(t => t.Id == id);
				if (datas != null)
				{
                    // 區域集合
                    List<string> Area = new List<string>();
                    // 抓區域資料
                    var AreaData = from t in db.SeatStocks
                    select t.Area;
                    // 丟進集合
                    foreach (var data in AreaData) 
                    { 
                      Area.Add(data.ToString()); 
                    }


                    // 區域集合
                    List<int> EventId = new List<int>();

                    var EventData = from t in db.Events
                                    select t.EventId;
                    foreach (var data in EventData)
                    {
                        EventId.Add((Int32)data);
                    }


                    ViewBag.OrderId = (datas.OrderId).ToString();
                    ViewBag.Area = Area;
                    ViewBag.EventId = EventId;

                    return View(datas);
				}
			}
			return RedirectToAction("List_Detail");
		}
		[HttpPost]
		public IActionResult Edit_Detail(TicketOrderDetail t)
		{

			YoungArtistsContext db = new YoungArtistsContext();
			int? Detail_id = 0;

			var datas = db.TicketOrderDetails.FirstOrDefault(d => d.Id == t.Id);
			if (datas != null)
			{
                datas.EventId = t.EventId;
				datas.Area = t.Area;
				datas.SeatId = t.SeatId;
				Detail_id = datas.OrderId;

				db.SaveChanges();

				return RedirectToAction("List_Detail",new { id = Detail_id });
			}

			return RedirectToAction("List_Detail");
		}

        public IActionResult Delete_Detail(int? id)
        {
            YoungArtistsContext db = new YoungArtistsContext();
			int? Detail_id = 0;
			if (id != null)
            {
                var datas_detail = db.TicketOrderDetails.FirstOrDefault(t => t.Id == id);
                // 要回頭找座位價格 然後扣訂單總金額
                var datas = db.TicketOrders.FirstOrDefault(t => t.OrderId == datas_detail.OrderId);
                Detail_id = datas_detail.OrderId;
                var stock = db.SeatStocks.FirstOrDefault(t => t.Area == datas_detail.Area && t.EventId == datas_detail.EventId) ;

                stock.Stock += 1;
                stock.Sold -= 1;

                datas.OrderTotalPrice -= stock.Price;

                db.Remove(datas_detail);
                db.SaveChanges();
                //List_Detail(Detail_id);
				return RedirectToAction("List_Detail", new { id = Detail_id });

			}

			return RedirectToAction("List_Detail");
        }

        public IActionResult Delete_Detail_All(int? OrderId)
        {
            YoungArtistsContext db = new YoungArtistsContext();

            if (OrderId != null)
            {
                var datas_detail = db.TicketOrderDetails.FirstOrDefault(t => t.OrderId == OrderId);
                // 要回頭找座位價格 然後扣訂單總金額
                var Detail_id = datas_detail.OrderId;
                var stock = db.SeatStocks.FirstOrDefault(t => t.Area == datas_detail.Area && t.EventId == datas_detail.EventId);
                stock.Stock += 1;
                stock.Sold -= 1;

                db.Remove(datas_detail);
                db.SaveChanges();
                List_Detail(Detail_id);
            }

            return RedirectToAction("List_Detail");
        }
    }
}
